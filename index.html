<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv';

  fetch(csvUrl)
    .then(res => res.arrayBuffer())
    .then(buffer => {
      const decoder = new TextDecoder('utf-8'); // <--- –Ω–µ windows-1251
      let csvText = decoder.decode(buffer);

      // –£–¥–∞–ª–∏–º BOM, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (csvText.charCodeAt(0) === 0xFEFF) {
        csvText = csvText.slice(1);
      }

      const data = Papa.parse(csvText, { header: true, skipEmptyLines: true }).data;

      console.log("üì¶ –ü–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç:", data[0]);

      const labels = [];
      const revenue = [];

      data.forEach(row => {
        const date = row['–î–∞—Ç–∞'];
        const raw = row['–¢–û'];
        if (date && raw) {
          const value = parseFloat(String(raw).replace(/\s/g, '').replace(',', '.'));
          if (!isNaN(value)) {
            labels.push(date);
            revenue.push(value);
          }
        }
      });

      const ctx = document.getElementById('revenueChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.slice(-14),
          datasets: [{
            label: '–í—ã—Ä—É—á–∫–∞',
            data: revenue.slice(-14),
            backgroundColor: 'rgba(255,255,255,0.8)',
            borderColor: '#fff',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: {
            legend: {
              labels: { color: '#ff4081' }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV:', err);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV: ' + err.message);
    });
</script>
