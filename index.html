<!-- HTML структура остаётся без изменений -->
<!-- Ниже вставляется обновлённая реализация fetchPlanAndRecordData -->
<script>
  const plansUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=1774855984&single=true&output=csv";
  const recordsUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=143269600&single=true&output=csv";
  const dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv";

  async function fetchPlanAndRecordData() {
    const [planText, recordText, dataText] = await Promise.all([
      fetch(plansUrl).then(r => r.text()),
      fetch(recordsUrl).then(r => r.text()),
      fetch(dataUrl).then(r => r.text())
    ]);

    const planData = Papa.parse(planText, { header: true }).data;
    const recordData = Papa.parse(recordText, { header: true }).data;
    const fullData = Papa.parse(dataText, { header: true }).data;

    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    const currentDay = now.getDate();

    const thisMonthData = fullData.filter(r => {
      const d = new Date(r["Дата"]);
      return d.getMonth() === currentMonth && d.getFullYear() === currentYear && d.getDate() <= currentDay && r["ТО"];
    });

    const pastYearData = fullData.filter(r => {
      const d = new Date(r["Дата"]);
      return d.getMonth() === currentMonth && d.getFullYear() === currentYear - 1 && d.getDate() <= currentDay && r["ТО"];
    });

    const toNum = s => parseFloat(String(s || '').replace(/\s/g, '').replace(',', '.')) || 0;

    const sum = (arr, key) => arr.reduce((acc, row) => acc + toNum(row[key]), 0);
    const avg = (arr, key) => arr.length ? sum(arr, key) / arr.length : 0;

    const avgTO = avg(thisMonthData, "ТО");
    const avgTR = avg(thisMonthData, "ТР");
    const avgCHK = avg(thisMonthData, "СРЧ");

    document.getElementById("factRevenue").textContent = Math.round(avgTO).toLocaleString("ru-RU") + "₽";
    document.getElementById("factTraffic").textContent = Math.round(avgTR).toLocaleString("ru-RU") + " чел.";
    document.getElementById("factCheck").textContent = Math.round(avgCHK).toLocaleString("ru-RU") + "₽";

    document.getElementById("planRevenue").textContent = planData[0]["ТО"] + "₽";
    document.getElementById("planTraffic").textContent = planData[0]["ТР"] + " чел.";
    document.getElementById("planCheck").textContent = planData[0]["СРЧ"] + "₽";

    document.getElementById("recordRevenue").textContent = recordData[0]["ТО"] + "₽";
    document.getElementById("recordRevenueLabel").textContent = recordData[0]["Дата ТО"];
    document.getElementById("recordTraffic").textContent = recordData[0]["ТР"] + " чел.";
    document.getElementById("recordTrafficLabel").textContent = recordData[0]["Дата ТР"];

    const currentTotal = sum(thisMonthData, "ТО");
    const pastTotal = sum(pastYearData, "ТО");
    const compare = pastTotal ? ((currentTotal - pastTotal) / pastTotal * 100) : 0;
    document.getElementById("lastYearCompare").textContent = (compare > 0 ? "+" : "") + compare.toFixed(1) + "%";
  }
</script>
