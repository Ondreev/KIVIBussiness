<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>КИВИ Business</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #ff4081;
      font-family: sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
    }
    h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 20px 0 10px;
    }
    h1 span { font-weight: 400; }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 20px;
      width: 95%;
      max-width: 600px;
      box-sizing: border-box;
    }

    .cell {
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      text-align: center;
      padding: 8px;
    }

    .big {
      font-size: 20px;
      font-weight: bold;
      color: #fff;
    }

    .small {
      font-size: 13px;
      margin-top: 4px;
      color: #fff;
    }

    #chartContainer {
      border-radius: 16px;
      padding: 10px;
      width: 95%;
      max-width: 600px;
      box-sizing: border-box;
    }

    canvas {
      width: 100% !important;
      height: 125px !important;
    }

    .custom-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
    }

    .label-item {
      text-align: center;
      width: 14%;
    }

    .revenue {
      font-size: 15px;
      font-weight: bold;
      color: #fff;
    }

    .date {
      font-size: 13px;
      font-weight: 400;
      color: #fff;
    }

    .compare-block {
      background: white;
      color: black;
      width: 95%;
      max-width: 600px;
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      box-sizing: border-box;
      margin-top: 16px;
    }

    .compare-block h2 {
      margin-top: 0;
      font-size: 16px;
    }

    #compareTable table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    #compareTable th, #compareTable td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }

    .hidden-row {
      display: none;
    }

    .highlight {
      background: #d4edda;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>КИВИ <span>Business</span></h1>

  <!-- Верхний блок -->
  <div class="grid" id="summaryBlock">
    <!-- JS подставит сюда данные -->
    <div class="cell"><div class="big" id="planTo">0₽</div><div class="small">План TO</div></div>
    <div class="cell"><div class="big" id="planTraffic">0 чел.</div><div class="small">План трафик</div></div>
    <div class="cell"><div class="big" id="planAvg">0₽</div><div class="small">План СРЧ</div></div>

    <div class="cell"><div class="big" id="factTo">–</div><div class="small">Факт TO</div></div>
    <div class="cell"><div class="big" id="factTraffic">–</div><div class="small">Факт трафик</div></div>
    <div class="cell"><div class="big" id="factAvg">–</div><div class="small">Факт СРЧ</div></div>

    <div class="cell"><div class="big" id="recordTo">–</div><div class="small">Рекорд TO</div></div>
    <div class="cell"><div class="big" id="recordTraffic">–</div><div class="small">Рекорд Трафик</div></div>
    <div class="cell"><div class="big" id="comparePrev">–</div><div class="small">К ПГ</div></div>
  </div>

  <!-- График -->
  <div id="chartContainer">
    <canvas id="salesChart"></canvas>
    <div id="customLabels" class="custom-labels"></div>
  </div>

  <!-- Сравнение по дням -->
  <div class="compare-block">
    <h2>Сравнение по дням</h2>
    <div id="compareTable"></div>
    <button onclick="toggleRows()">Показать все</button>
  </div>

  <script>
    const urls = {
      data: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv",
      plans: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=1774855984&single=true&output=csv",
      records: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=143269600&single=true&output=csv"
    };

    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      return Papa.parse(text, { header: true }).data;
    }

    async function loadSummary() {
      const [data, plans, records] = await Promise.all([
        loadCSV(urls.data),
        loadCSV(urls.plans),
        loadCSV(urls.records)
      ]);

      const today = new Date();
      const ym = today.toISOString().slice(0, 7);
      const monthRows = data.filter(r => r["Дата"]?.startsWith(ym) && r["ТО"]);
      const lastYearRows = data.filter(r => {
        const d = new Date(r["Дата"]);
        return d.getFullYear() === today.getFullYear() - 1 &&
               d.getMonth() === today.getMonth();
      });

      const planRow = plans.find(r => r["Месяц"] === ym);
      const planTo = parseInt(planRow?.["План по выручке"] || 0);
      const planTr = parseInt(planRow?.["План по трафику"] || 0);
      const planAvg = planTo && planTr ? Math.round(planTo / planTr) : 0;

      const totalTo = monthRows.reduce((sum, r) => sum + parseFloat((r["ТО"] || '0').replace(/\s/g, '').replace(",", ".")), 0);
      const totalTr = monthRows.reduce((sum, r) => sum + parseInt(r["ТР"] || 0), 0);
      const avgCheck = totalTr ? Math.round(totalTo / totalTr) : 0;

      document.getElementById("planTo").textContent = planTo.toLocaleString("ru-RU") + "₽";
      document.getElementById("planTraffic").textContent = planTr + " чел.";
      document.getElementById("planAvg").textContent = planAvg + "₽";
      document.getElementById("factTo").textContent = Math.round(totalTo).toLocaleString("ru-RU") + "₽";
      document.getElementById("factTraffic").textContent = totalTr;
      document.getElementById("factAvg").textContent = avgCheck + "₽";

      const recTo = records.find(r => r["Показатель"]?.includes("выручка"));
      const recTr = records.find(r => r["Показатель"]?.includes("трафик"));
      document.getElementById("recordTo").textContent = parseInt(recTo?.Значение || 0).toLocaleString("ru-RU") + "₽";
      document.getElementById("recordTraffic").textContent = recTr?.Значение || 0;

      const thisTo = totalTo;
      const prevTo = lastYearRows.reduce((s, r) => s + parseFloat((r["ТО"] || '0').replace(/\s/g, '').replace(",", ".")), 0);
      const diff = prevTo ? Math.round((thisTo - prevTo) / prevTo * 100) : 0;
      document.getElementById("comparePrev").textContent = (diff >= 0 ? "+" : "") + diff + "%";
    }

    async function loadChart() {
      const csv = await loadCSV(urls.data);
      const rows = csv.filter(r => r["Дата"] && r["ТО"]);
      const last7 = rows.slice(-7);

      const labels = last7.map(row => {
        const date = new Date(row["Дата"]);
        const weekday = date.toLocaleDateString("ru-RU", { weekday: 'short' });
        const day = date.getDate();
        return `${day} ${weekday}`;
      });

      const revenues = last7.map(row => parseFloat(row["ТО"].replace(/\s/g, '').replace(',', '.')));
      const highlight = last7.map(row => row["Выполнение плана (Да/Нет)"]?.trim().toLowerCase() === "да");
      const maxValue = Math.max(...revenues);
      const yMax = Math.ceil(maxValue / 10000) * 10000;

      const ctx = document.getElementById("salesChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            data: revenues,
            backgroundColor: highlight.map(done => done ? '#FFD700' : '#FFFFFF'),
            borderRadius: 10,
            barPercentage: 0.8,
            categoryPercentage: 0.8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: { display: false }
          },
          scales: {
            y: {
              display: true,
              min: 0,
              max: yMax,
              grid: {
                drawTicks: false,
                drawBorder: false,
                color: context => context.tick.value % 10000 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent',
                lineWidth: 1
              },
              ticks: { display: false, stepSize: 10000 }
            },
            x: {
              ticks: { display: false },
              grid: { display: false }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      const labelContainer = document.getElementById("customLabels");
      labelContainer.innerHTML = "";
      labels.forEach((label, i) => {
        const div = document.createElement("div");
        div.className = "label-item";
        div.innerHTML = `<div class='revenue'>${revenues[i].toLocaleString('ru-RU')}</div><div class='date'>${label}</div>`;
        labelContainer.appendChild(div);
      });
    }

    // Сравнение по дням
    let allDataRows = [], showingAll = false;
    async function buildComparisonBlock() {
      const raw = await fetch(urls.data).then(r => r.text());
      const data = Papa.parse(raw, { header: true }).data;

      const now = new Date();
      const thisMonth = now.toISOString().slice(0, 7);
      const lastYearDate = new Date(now); lastYearDate.setFullYear(now.getFullYear() - 1);
      const lastYearMonth = lastYearDate.toISOString().slice(0, 7);

      const rowsThisYear = data.filter(row => row["Дата"]?.startsWith(thisMonth));
      const rowsLastYear = data.filter(row => row["Дата"]?.startsWith(lastYearMonth));

      const parseRows = rows => Object.fromEntries(rows.map(r => {
        const day = parseInt(r["Дата"].split("-")[2]);
        const date = new Date(r["Дата"]);
        const weekday = date.toLocaleDateString('ru-RU', { weekday: 'short' });
        const traffic = Math.round(parseFloat(r["ТР"]?.replace(',', '.') || 0));
        const revenue = Math.round(parseFloat(r["ТО"]?.replace(',', '.').replace(/\s/g, '') || 0));
        return [day, { day, weekday, traffic, revenue }];
      }));

      const byDayThis = parseRows(rowsThisYear);
      const byDayLast = parseRows(rowsLastYear);
      const maxDay = Math.max(...Object.keys(byDayThis).map(Number));
      const days = Array.from({ length: maxDay }, (_, i) => maxDay - i).filter(d => byDayThis[d]);

      const table = document.createElement('table');
      table.innerHTML = `<tr><th>День</th><th>Прошлый год</th><th>Текущий год</th></tr>`;

      allDataRows = days.map((day, i) => {
        const current = byDayThis[day];
        const last = byDayLast[day] || { weekday: '-', traffic: 0, revenue: 0 };
        const row = document.createElement('tr');
        if (i >= 6) row.classList.add('hidden-row');
        if (current.revenue > last.revenue) row.classList.add('highlight');
        row.innerHTML = `
          <td>${day}</td>
          <td>${last.weekday}, ${last.revenue.toLocaleString('ru-RU')}₽, ${last.traffic} чел.</td>
          <td>${current.weekday}, ${current.revenue.toLocaleString('ru-RU')}₽, ${current.traffic} чел.</td>`;
        return row;
      });

      allDataRows.forEach(r => table.appendChild(r));
      document.getElementById("compareTable").appendChild(table);
    }

    function toggleRows() {
      showingAll = !showingAll;
      allDataRows.forEach((r, i) => {
        r.classList.toggle('hidden-row', !showingAll && i >= 6);
      });
      event.target.textContent = showingAll ? 'Скрыть' : 'Показать все';
    }

    loadSummary();
    loadChart();
    buildComparisonBlock();
  </script>
</body>
</html>
