<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv';

  fetch(csvUrl)
    .then(res => res.arrayBuffer())
    .then(buffer => {
      const decoder = new TextDecoder('utf-8');
      let text = decoder.decode(buffer);

      // Удаляем BOM, если есть
      if (text.charCodeAt(0) === 0xFEFF) {
        text = text.slice(1);
      }

      const parsed = Papa.parse(text, { skipEmptyLines: true });
      const rows = parsed.data;

      const headers = rows[0];
      const indexDate = headers.findIndex(h => h.includes('Дата'));
      const indexRevenue = headers.findIndex(h => h.includes('ТО'));

      if (indexDate === -1 || indexRevenue === -1) {
        alert('Не найдены нужные колонки (Дата, ТО).');
        return;
      }

      const labels = [];
      const revenue = [];

      rows.slice(1).forEach(row => {
        const date = row[indexDate];
        const rawRevenue = row[indexRevenue];
        if (date && rawRevenue) {
          const num = parseFloat(String(rawRevenue).replace(/\s/g, '').replace(',', '.'));
          if (!isNaN(num)) {
            labels.push(date);
            revenue.push(num);
          }
        }
      });

      if (labels.length === 0) {
        alert('Нет данных для отображения.');
        return;
      }

      const ctx = document.getElementById('revenueChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.slice(-14),
          datasets: [{
            label: 'Выручка',
            data: revenue.slice(-14),
            backgroundColor: 'rgba(255,255,255,0.8)',
            borderColor: '#fff',
            borderWidth: 1
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: {
            legend: {
              labels: { color: '#ff4081' }
            }
          }
        }
      });
    })
    .catch(err => {
      console.error('Ошибка:', err);
      alert('Ошибка загрузки CSV: ' + err.message);
    });
</script>
