<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv";

  fetch(csvUrl)
    .then(response => response.text())
    .then(csvText => {
      const parsed = Papa.parse(csvText, { header: true });
      const data = parsed.data.filter(row => row["Дата"] && row["ТО"]);
      const last10 = data.slice(-10);

      const labels = last10.map(row => {
        const date = new Date(row["Дата"]);
        const options = { day: 'numeric', month: 'short', weekday: 'short' };
        const formattedDate = date.toLocaleDateString("ru-RU", options);
        const revenue = parseFloat(row["ТО"].replace(/\s/g, '').replace(',', '.'));
        return `${revenue.toLocaleString('ru-RU')} ₽\n${formattedDate}`;
      });

      const sales = last10.map(row => {
        const cleaned = row["ТО"].replace(/\s/g, '').replace(',', '.');
        return parseFloat(cleaned);
      });

      new Chart(document.getElementById("salesChart"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Выручка",
            data: sales,
            backgroundColor: sales.map((val, idx) => idx === sales.length - 1 ? '#e91e63' : '#ff80ab'),
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y.toLocaleString("ru-RU")} ₽`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: '#000',
                font: {
                  size: 10,
                  family: 'Arial',
                  weight: 'bold'
                },
                callback: function(value, index, values) {
                  const lines = this.getLabelForValue(value).split('\n');
                  return [lines[0], lines[1]];
                }
              }
            },
            y: {
              ticks: {
                color: '#000',
                callback: val => val.toLocaleString("ru-RU")
              }
            }
          }
        }
      });
    })
    .catch(err => {
      alert("Ошибка загрузки данных. Проверьте ссылку на таблицу.");
      console.error(err);
    });
</script>
