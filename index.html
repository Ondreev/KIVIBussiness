<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>КИВИ Business</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #ff4081;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      font-weight: 900;
      margin-bottom: 20px;
    }
    h1 span {
      font-weight: normal;
    }
    #chartContainer {
      display: flex;
      flex-direction: column;
      background: rgba(255 255 255 / 0.1);
      border-radius: 16px;
      padding: 16px;
      max-width: 700px;
      width: 100%;
      user-select: none;
    }
    /* Контейнер для столбцов */
    #bars {
      display: flex;
      justify-content: center;
      gap: 12px;
      align-items: flex-end;
      height: 150px;
    }
    .bar {
      width: 40px;
      background: white;
      border-radius: 8px 8px 0 0;
      transition: background-color 0.3s ease;
      position: relative;
    }
    .bar.highlight {
      background: #ffeb3b; /* желтый */
    }
    /* Контейнер для подписей под столбцами */
    #labels {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
    }
    .label {
      width: 40px;
      color: white;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      line-height: 1.2;
      user-select: none;
    }
    .revenue {
      font-weight: 900;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .date-info {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>КИВИ <span>Business</span></h1>
  <div id="chartContainer">
    <div id="bars"></div>
    <div id="labels"></div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTM-GTiL5auNwSsi0SWkR5_YzX89K-J27vC5nw15bVJbkJRXrmXzNv4LDWb32xfVHNcYac0GnNsxJTI/pub?gid=2099900296&single=true&output=csv";

    fetch(csvUrl)
      .then(response => response.text())
      .then(csvText => {
        const parsed = Papa.parse(csvText, { header: true });
        const data = parsed.data.filter(row => row["Дата"] && row["ТО"]);

        // Берём последние 7 дней
        const last7 = data.slice(-7);

        const barsContainer = document.getElementById("bars");
        const labelsContainer = document.getElementById("labels");
        barsContainer.innerHTML = "";
        labelsContainer.innerHTML = "";

        // Найдём максимальную выручку для нормализации высоты столбцов
        const maxRevenue = Math.max(...last7.map(r => parseFloat(r["ТО"].replace(/\s/g, '').replace(',', '.'))));

        last7.forEach(row => {
          const revenue = parseFloat(row["ТО"].replace(/\s/g, '').replace(',', '.'));
          const planMet = (row["Выполнение плана (Да/Нет)"] || "").trim().toLowerCase() === "да";

          // Высота столбца пропорциональна выручке (макс 150px)
          const height = (revenue / maxRevenue) * 150;

          // Создаём столбец
          const bar = document.createElement("div");
          bar.className = "bar" + (planMet ? " highlight" : "");
          bar.style.height = height + "px";
          barsContainer.appendChild(bar);

          // Создаём подпись под столбцом
          const label = document.createElement("div");
          label.className = "label";

          // Выручка жирным сверху
          const revEl = document.createElement("div");
          revEl.className = "revenue";
          revEl.textContent = `${revenue.toLocaleString('ru-RU')} ₽`;

          // День недели и число под выручкой
          const date = new Date(row["Дата"]);
          const weekday = row["День недели"] || date.toLocaleDateString("ru-RU", { weekday: 'short' });
          const day = date.getDate();

          const dateEl = document.createElement("div");
          dateEl.className = "date-info";
          dateEl.innerHTML = `${weekday}<br>${day}`;

          label.appendChild(revEl);
          label.appendChild(dateEl);
          labelsContainer.appendChild(label);
        });
      })
      .catch(error => {
        alert("Ошибка загрузки. Проверьте ссылку на таблицу.");
        console.error(error);
      });
  </script>
</body>
</html>
